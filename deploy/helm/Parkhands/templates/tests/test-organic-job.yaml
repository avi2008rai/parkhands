---
{{- if not (eq .Values.migrateEnvVars.cicdNamespace "production") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.migrateEnvVars.cicdExecutionSequence }}-test-organic
  namespace: {{ .Values.migrateEnvVars.cicdTestNamespace }}
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 600
  template:
    spec:
      {{- if .Values.containerRegistryPrivate.pullSecret }}
      imagePullSecrets:
      - name: {{ .Values.containerRegistryPrivate.pullSecret }}
      {{- end }}
      initContainers:
      - name: git-sync
        image: {{ .Values.containerRegistryPublic.baseUrl }}alpine/git:v2.24.1
        command: ['sh', '-c']
        args:
          - |
            cd /workdir
            git clone --depth 1 https://$GIT_PASSWORD@{{ .Values.migrateEnvVars.gitCloneUrl }} -b {{ .Values.migrateEnvVars.cicdGitBranch }} parkhands
            cd parkhands
            git fetch origin {{ .Values.migrateEnvVars.cicdGitRef }}:pr-1
            git status
        volumeMounts:
        - name: git-source
          mountPath: /workdir
        env:
          - name: GIT_USERNAME
            valueFrom:
              secretKeyRef:
                name: github-credentials
                key: username
          - name: GIT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: github-credentials
                key: password
      - name: wait-graphql
        image: {{ .Values.containerRegistryPublic.baseUrl }}radial/busyboxplus:curl
        command: ['sh', '-c']
        args:
          - |
            until curl -sSf -X POST -H "Content-Type: application/json" --data '{"query": "{ languagesList { name } }"}' ${GRAPHQL_API_URL} > /dev/null; do echo waiting for GraphQL API; sleep 2; done;
        env:
        - name: GRAPHQL_API_URL
          value: http://graphql:5000/graphql
      containers:
      - name: ph-test-organic
        image: {{ .Values.containerRegistryPrivate.baseUrl  }}ph_organic:{{ .Values.migrateEnvVars.deployOrganicImageTag }}
        imagePullPolicy: IfNotPresent
        securityContext:
            allowPrivilegeEscalation: false
        command: ['sh', '-c']
        args:
          - |
            npm run test --prefix cells/event-hub
            npm run test --prefix cells/file-api
            npm run test --prefix cells/rest-api
        envFrom:
        - configMapRef:
            name: env-configmap
        - secretRef:
            name: env-secrets
        volumeMounts:
        - name: git-source
          mountPath: /organic/cells/event-hub/shared
          subPath: parkhands/shared
        - name: git-source
          mountPath: /organic/cells/file-api/shared
          subPath: parkhands/shared
        - name: git-source
          mountPath: /organic/cells/rest-api/shared
          subPath: parkhands/shared
      restartPolicy: Never
      volumes:
      - name: git-source
        emptyDir: {}
{{- else }}
{{ end -}}
